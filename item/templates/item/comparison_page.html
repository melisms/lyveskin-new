{% extends 'lyve/base.html' %}
{% block content %}

<style>
  .comparison-container {
    max-width: 960px;
    margin: 2rem auto;
    padding: 1rem;
  }
  h1, p.category {
    text-align: center;
    color: #2c3e50;
  }
  p.category {
    font-size: 1.25rem;
    margin-top: 0.5rem;
    font-weight: 600;
  }
  .items-row {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 2rem;
    margin-top: 2rem;
  }
  .item-card {
    background: #f9fafb;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(64, 130, 109, 0.12);
    padding: 1.5rem;
    flex: 1 1 320px;
    max-width: 350px;
    text-align: center;
  }

  .chart-image-wrapper {
    position: relative;
    width: 280px;
    height: 280px;
    margin: 0 auto 1rem auto;
  }
  .chart-image-wrapper canvas {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
  }
  .chart-image-wrapper img {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 185px;  
    height: 185px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    object-fit: cover;
  
    z-index: 2;
  }

  .item-name {
    font-weight: 700;
    font-size: 1.5rem;
    color: #244a3a;
    margin-bottom: 1rem;
    word-wrap: break-word;
  }
  .ingredient-stats b {
    font-weight: 700;
  }
  .ingredient-stats span.safe {
    color: #4caf50;
  }
  .ingredient-stats span.risky {
    color: #f44336;
  }
  .ingredients-list {
    margin-top: 1rem;
    margin-bottom: 1.5rem;
    font-size: 1rem;
    line-height: 1.4;
  }
  .ingredients-list span {
    font-weight: 600;
    margin-right: 0.25rem;
  }
  .ingredients-list span.safe {
    color: #4caf50;
  }
  .ingredients-list span.risky {
    color: #f44336;
  }
  .health-score {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: #2c3e50;
  }
  canvas {
  position: relative;
  z-index: 10; /* Tooltip üstte çıksın */
}
.chartjs-tooltip {
  z-index: 9999 !important; /* Tooltip her şeyin üstünde */
}

  @media (max-width: 768px) {
    .items-row {
      flex-direction: column;
      align-items: center;
    }
    .item-card {
      max-width: 90%;
    }
  }
</style>

<div class="comparison-container">
    <h1>Comparison Results</h1>
    <p class="category"><b>Category:</b> {{ category }}</p>

    <div class="items-row">
        <!-- Item 1 -->
        <div class="item-card">
            <div class="chart-image-wrapper">
                <canvas id="healthChart1" width="280" height="280"></canvas>
                <img src="{{ item1.image.url }}" alt="{{ item1 }}" />
            </div>
            <h3 class="health-score">Health Score: <span id="healthScoreItem1">{{ item1_health_score }}</span>/100</h3>


            <p class="item-name">{{ item1 }}</p>

            <p class="ingredient-stats">
                <b><span class="safe">Safe</span> Ingredients:</b> {{ item1_safe_count }}<br>
                <b><span class="risky">Risky</span> Ingredients:</b> {{ item1_risky_count }}
            </p>

            <p class="ingredients-list">
                <b>Ingredients:</b>
                {% for ingredient in item1.ingredients.all %}
                    <span class="{% if ingredient.safety == 'S' %}safe{% elif ingredient.safety == 'R' %}risky{% endif %}">{{ ingredient.name }}</span>{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </p>

        </div>

        <!-- Item 2 -->
        <div class="item-card">
            <div class="chart-image-wrapper">
                <canvas id="healthChart2" width="280" height="280"></canvas>
                <img src="{{ item2.image.url }}" alt="{{ item2 }}" />
            </div>
            <h3 class="health-score"> Health Score: <span id="healthScoreItem2">{{ item2_health_score }}</span>/100</h3>

            <p class="item-name">{{ item2 }}</p>

            <p class="ingredient-stats">
                <b><span class="safe">Safe</span> Ingredients:</b> {{ item2_safe_count }}<br>
                <b><span class="risky">Risky</span> Ingredients:</b> {{ item2_risky_count }}
            </p>

            <p class="ingredients-list">
                <b>Ingredients:</b>
                {% for ingredient in item2.ingredients.all %}
                    <span class="{% if ingredient.safety == 'S' %}safe{% elif ingredient.safety == 'R' %}risky{% endif %}">{{ ingredient.name }}</span>{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </p>

            
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const item1SafeCount = {{ item1_safe_count }};
    const item1RiskyCount = {{ item1_risky_count }};
    const item2SafeCount = {{ item2_safe_count }};
    const item2RiskyCount = {{ item2_risky_count }};

    function calculateHealthScore(safeCount, riskyCount) {
        const totalCount = safeCount + riskyCount;
        if (totalCount === 0) return 100;
        return Math.round((safeCount / totalCount) * 100);
    }

    const item1HealthScore = calculateHealthScore(item1SafeCount, item1RiskyCount);
    const item2HealthScore = calculateHealthScore(item2SafeCount, item2RiskyCount);

    function getScoreColor(score) {
        if (score <= 40) return '#F44336';   // kırmızı
        if (score <= 75) return '#FFC107';   // sarı
        return '#4CAF50';                    // yeşil
    }

    // Sadece sayı kısmını renklendir
    const scoreElem1 = document.getElementById('healthScoreItem1');
    scoreElem1.innerText = item1HealthScore;
    scoreElem1.style.color = getScoreColor(item1HealthScore);

    const scoreElem2 = document.getElementById('healthScoreItem2');
    scoreElem2.innerText = item2HealthScore;
    scoreElem2.style.color = getScoreColor(item2HealthScore);

    // Chart config
   const chartOptions = {
  cutout: '70%',
  plugins: {
    legend: { display: false }, // Alt legend kapalı
    tooltip: {
      enabled: false, // Default tooltip kapalı
      external: function(context) {
        let tooltipEl = document.getElementById('chartjs-tooltip');
        if (!tooltipEl) {
          tooltipEl = document.createElement('div');
          tooltipEl.id = 'chartjs-tooltip';
          tooltipEl.style.position = 'absolute';
          tooltipEl.style.background = 'rgba(0, 0, 0, 0.85)';
          tooltipEl.style.color = '#fff';
          tooltipEl.style.borderRadius = '6px';
          tooltipEl.style.padding = '8px 12px';
          tooltipEl.style.fontSize = '14px';
          tooltipEl.style.fontWeight = '600';
          tooltipEl.style.boxShadow = '0 4px 10px rgba(0,0,0,0.3)';
          tooltipEl.style.pointerEvents = 'none';
          tooltipEl.style.transition = 'all 0.1s ease';
          tooltipEl.style.zIndex = '9999'; 
          document.body.appendChild(tooltipEl);
        }

        const tooltipModel = context.tooltip;
        if (tooltipModel.opacity === 0) {
          tooltipEl.style.opacity = 0;
          return;
        }

        if (tooltipModel.body) {
          const dataPoint = tooltipModel.dataPoints[0];
          const label = dataPoint.label; // Safe / Risky
          const value = parseFloat(dataPoint.raw);
          
          // Toplam ve yüzde hesapla
          const total = dataPoint.dataset.data.reduce((a, b) => a + b, 0);
          const percentage = ((value / total) * 100).toFixed(1);

          // Renk kutucuğunu bul
          const colorBox = dataPoint.element.options.backgroundColor;

          tooltipEl.innerHTML = `
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="
                width:12px;
                height:12px;
                background:${colorBox};
                display:inline-block;
                border-radius:3px;
              "></span>
              <span>${label}: ${percentage}%</span>
            </div>
          `;
        }

        const position = context.chart.canvas.getBoundingClientRect();
        tooltipEl.style.opacity = 1;
        tooltipEl.style.left = position.left + window.scrollX + tooltipModel.caretX + 15 + 'px';
        tooltipEl.style.top = position.top + window.scrollY + tooltipModel.caretY + 15 + 'px';
      }
    }
  }
};



    const ctx1 = document.getElementById('healthChart1').getContext('2d');
   new Chart(ctx1, {
  type: 'doughnut',
  data: {
    labels: ['Safe', 'Risky'],
    datasets: [{
      data: [item1SafeCount, item1RiskyCount],
      backgroundColor: ['#4CAF50', '#F44336'],
      hoverOffset: 4
    }]
  },
  options: chartOptions
});

    const ctx2 = document.getElementById('healthChart2').getContext('2d');
    new Chart(ctx2, {
  type: 'doughnut',
  data: {
    labels: ['Safe', 'Risky'],
    datasets: [{
      data: [item2SafeCount, item2RiskyCount],
      backgroundColor: ['#4CAF50', '#F44336'],
      hoverOffset: 4
    }]
  },
  options: chartOptions
});

</script>



{% endblock %}
